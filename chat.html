<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home LLM Chat</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #1a1a1a;
    color: #e0e0e0;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    padding: 12px 20px;
    background: #252525;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  header h1 { font-size: 16px; font-weight: 600; }
  .status { font-size: 12px; color: #888; }
  .status.connected { color: #4caf50; }
  .status.error { color: #f44336; }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .message {
    max-width: 720px;
    width: 100%;
    margin: 0 auto;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .message.user {
    background: #2a2a3a;
    padding: 12px 16px;
    border-radius: 12px;
  }
  .message.assistant {
    padding: 4px 0;
  }
  @keyframes dotPulse {
    0%, 80%, 100% { opacity: 0.2; }
    40% { opacity: 1; }
  }
  .thinking span {
    animation: dotPulse 1.4s infinite;
    font-size: 20px;
    letter-spacing: 4px;
  }
  .thinking span:nth-child(2) { animation-delay: 0.2s; }
  .thinking span:nth-child(3) { animation-delay: 0.4s; }
  #input-area {
    padding: 16px 20px;
    background: #252525;
    border-top: 1px solid #333;
  }
  #input-form {
    max-width: 720px;
    margin: 0 auto;
    display: flex;
    gap: 10px;
  }
  #input-form textarea {
    flex: 1;
    padding: 10px 14px;
    background: #333;
    border: 1px solid #444;
    border-radius: 8px;
    color: #e0e0e0;
    font-family: inherit;
    font-size: 14px;
    resize: none;
    max-height: 120px;
  }
  #input-form textarea:focus { outline: none; border-color: #666; }
  #input-form button {
    padding: 10px 20px;
    background: #4a9eff;
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    cursor: pointer;
  }
  #input-form button:disabled { opacity: 0.5; cursor: not-allowed; }
  #input-form button:hover:not(:disabled) { background: #3a8eef; }
  .settings {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .settings select {
    background: #333;
    border: 1px solid #444;
    border-radius: 6px;
    color: #e0e0e0;
    padding: 4px 8px;
    font-size: 12px;
  }
</style>
</head>
<body>

<header>
  <h1>Home LLM</h1>
  <div class="settings">
    <select id="model-select"><option value="tinyllama">tinyllama</option></select>
    <span id="status" class="status">checking...</span>
  </div>
</header>

<div id="messages"></div>

<div id="input-area">
  <form id="input-form">
    <textarea id="prompt" rows="1" placeholder="Send a message..." autofocus></textarea>
    <button type="submit" id="send-btn">Send</button>
  </form>
</div>

<script>
const OLLAMA_URL = "http://10.0.0.3:11434";
const messagesEl = document.getElementById("messages");
const promptEl = document.getElementById("prompt");
const sendBtn = document.getElementById("send-btn");
const statusEl = document.getElementById("status");
const modelSelect = document.getElementById("model-select");

let conversation = [];
let generating = false;

// Auto-resize textarea
promptEl.addEventListener("input", () => {
  promptEl.style.height = "auto";
  promptEl.style.height = Math.min(promptEl.scrollHeight, 120) + "px";
});

// Submit on Enter (Shift+Enter for newline)
promptEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    document.getElementById("input-form").requestSubmit();
  }
});

// Check connection and load models
async function checkConnection() {
  try {
    const res = await fetch(OLLAMA_URL + "/api/tags");
    const data = await res.json();
    statusEl.textContent = "connected";
    statusEl.className = "status connected";
    modelSelect.textContent = "";
    data.models.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.name;
      opt.textContent = m.name;
      modelSelect.appendChild(opt);
    });
  } catch {
    statusEl.textContent = "disconnected";
    statusEl.className = "status error";
  }
}

function addMessage(role, content) {
  const div = document.createElement("div");
  div.className = "message " + role;
  div.textContent = content;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return div;
}

document.getElementById("input-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = promptEl.value.trim();
  if (!text || generating) return;

  generating = true;
  sendBtn.disabled = true;
  promptEl.value = "";
  promptEl.style.height = "auto";

  addMessage("user", text);
  conversation.push({ role: "user", content: text });

  const assistantDiv = document.createElement("div");
  assistantDiv.className = "message assistant thinking";
  assistantDiv.append(
    Object.assign(document.createElement("span"), { textContent: "." }),
    Object.assign(document.createElement("span"), { textContent: "." }),
    Object.assign(document.createElement("span"), { textContent: "." })
  );
  messagesEl.appendChild(assistantDiv);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  try {
    const res = await fetch(OLLAMA_URL + "/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: modelSelect.value,
        messages: conversation,
        stream: true
      })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullResponse = "";
    let firstToken = true;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value);
      const lines = chunk.split("\n").filter(l => l.trim());
      for (const line of lines) {
        try {
          const json = JSON.parse(line);
          if (json.message && json.message.content) {
            if (firstToken) {
              assistantDiv.textContent = "";
              assistantDiv.classList.remove("thinking");
              firstToken = false;
            }
            fullResponse += json.message.content;
            assistantDiv.textContent = fullResponse;
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }
        } catch (parseErr) {
          // skip malformed chunks
        }
      }
    }

    conversation.push({ role: "assistant", content: fullResponse });
  } catch (err) {
    assistantDiv.textContent = "Error: Could not reach server. Is Ollama running?";
    assistantDiv.classList.remove("thinking");
    assistantDiv.style.color = "#f44336";
  }

  generating = false;
  sendBtn.disabled = false;
  promptEl.focus();
});

checkConnection();
setInterval(checkConnection, 30000);
</script>

</body>
</html>
